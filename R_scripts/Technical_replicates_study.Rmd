---
title: "Analysis of technical replicates"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
fig_width: 15
fig_height: 17
---

Sample 9 and sample 2 were processed in parallel, in triplicate, to assess how much variability the sample processing introduces.

Here, I am analyzing this, by checking CV% across replicates.

### Admin

```{r}
#old.packages()    # tells me which pack are old
#update.packages(ask = FALSE)
```

### Relevant packages

```{r}
library(readxl)
library(tidyverse)
extrafont::loadfonts(device="win")
extrafont::font_import()
library(ggplot2)
devtools::install_github('bbc/bbplot')
library(scales)
library(patchwork)

# extrafont::font_import(paths = NULL, recursive = TRUE, prompt = FALSE)

```

### Load material

```{r}
load("~/MTLS/rep/Data/Output_data/wide_matrix.RDa")    # this is a purely numerical matrix with samples on rows, prot on cols
Metatable <- read_excel('~/MTLS/rep/Data/Metadata/Metatable.xlsx')
load("~/MTLS/rep/Data/Output_data/info_to_analyze.Rda")   # this df contains samples on rows, col both prot and info

wide_matrix_t<- as.data.frame(t(wide_matrix))
```

# Analysis

### Extract replicate rows

```{r}
# Name of replicate samples
sample_2_IDs <- c('R_2_SCR_R1_Set1_tmt16plex_131N', 'R_2_SCR_R2_Set1_tmt16plex_132N', 'R_2_SCR_R3_Set1_tmt16plex_133N')
sample_9_IDs <- c('NR_9_SCR_R1_Set2_tmt16plex_127C', 'NR_9_SCR_R2_Set2_tmt16plex_128C', 'NR_9_SCR_R3_Set2_tmt16plex_129C')

wide_matrix_t_repl <- wide_matrix_t %>% select(c(sample_2_IDs, sample_9_IDs))

repl_sample_2 <- wide_matrix_t_repl %>% select(all_of(sample_2_IDs))
repl_sample_9 <- wide_matrix_t_repl %>% select(all_of(sample_9_IDs))

head(repl_sample_2)

```

### Calculate means

```{r}
repl_sample_2$mean <- rowMeans(repl_sample_2, na.rm=T)
repl_sample_9$mean <- rowMeans(repl_sample_9, na.rm=T)

repl_sample_2$sd <- apply(repl_sample_2, 1, sd, na.rm=TRUE)
repl_sample_9$sd <- apply(repl_sample_9, 1, sd, na.rm=TRUE)
```

### Calculate CV using Nidhi's formula

```{r}
### The formula: SQRT(EXP(STDEV(X:Z)^2)-1)*100

CV <- function(x) {sqrt(exp(x**2)-1)*100}

CV_2 <- lapply(repl_sample_2[c('sd')], CV)  # calcs CV on sd value
CV_9 <- lapply(repl_sample_9[c('sd')], CV)  # calcs CV on sd value

repl_sample_2$CV <- CV_2$sd   # adds cv as a col
repl_sample_9$CV <- CV_9$sd   # adds cv as a col

```

```{r}
# Only need to do this once
repl_sample_2 <- tibble::rownames_to_column(repl_sample_2, "Protein")
repl_sample_9 <- tibble::rownames_to_column(repl_sample_9, "Protein")
```

### Plot CVs as barplots across all proteins

```{r}

### sample 2 ###
repl2_barplot <- ggplot(repl_sample_2, aes(x=Protein, y = CV )) +
  geom_bar(stat = "identity", color="#1380A1") +   geom_hline(yintercept = 25, linewidth = 0.5, colour="coral3", lty=2) +
  geom_hline(yintercept = 0, linewidth = 1, colour="#333333")+
 bbplot::bbc_style() +
  labs(title="Spread CV for sample 2",
       subtitle = "Variance across 3 technical replicates",
       y = "CV (%)",
       x = 'Proteins (1738 unique)') +
   scale_y_continuous(breaks=c(0, 25, 50, 100, 200, 300), limits = c(0,300)) +
  theme(plot.title = element_text(size = 15, face = 'bold', vjust = -3), plot.subtitle = element_text(size = 12, vjust = -3), axis.text.x = element_blank(), axis.title.x = element_text(size = 10),  axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 8))



### sample 9 ###
repl9_barplot <- ggplot(repl_sample_9, aes(x=Protein, y = CV )) +
  geom_bar(stat = "identity", color="#1380A1") +
  geom_hline(yintercept = 25, linewidth = 0.5, colour="coral3", lty=2) +
  geom_hline(yintercept = 0, linewidth = 1, colour="#333333")+
 bbplot::bbc_style() +
  labs(title="Spread CV for sample 9",
       subtitle = "Variance across 3 technical replicates",
       y = "CV (%)",
       x = 'Proteins (1473 unique)') +
   scale_y_continuous(breaks=c(0, 25, 50, 100, 200, 300, 400, 500), limits=c(0, 500)) +
  theme(plot.title = element_text(size = 15, face = 'bold', vjust = -4), plot.subtitle = element_text(size = 12, vjust = -3), axis.text.x = element_blank(), axis.title.x = element_text(size = 10),  axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 8))

repl9_barplot + theme_gray()

## Combine

layout <- repl2_barplot / repl9_barplot
layout &  theme(plot.tag = element_text(size = 14))

```

### How many proteins have a CV above 50%, how many NAs?

```{r}
# CV > 50
nrow(na.omit(repl_sample_2[repl_sample_2$CV < 25, ]))   # 1466
nrow(na.omit(repl_sample_9[repl_sample_9$CV < 25, ]))   # 1119

# NAs
sum(is.na(repl_sample_2$CV))    # 59
sum(is.na(repl_sample_9$CV))   # 324

#max
max(na.omit(repl_sample_2$CV))  # 301
max(na.omit(repl_sample_9$CV))   # 611


```

For sample 2:

-   Out of 1738 unique proteins, 1466 (84.3%) of protein have CV below 25%. Max CV is 231%.

For sample 9:

-   Out of 1473 unique proteins, 1119 (75.9%) of proteins have a CV below 25%. Max CV is 444%.

```{r}

### What I did before (15th Apr 2023)
#info_replicates <- info_to_analyse %>% filter(Replicate %in% c(1,2,3))   # generate df

# CV
#replicates_cv <- info_replicates %>% group_by(Sample_nr) %>% select(12:1797) %>% sapply(function(x) sd(x, na.rm=T) / mean(x, na.rm=T) * 100)

#replicates_cv <- info_replicates %>% group_by(Sample_nr) %>% summarise(across(12:1796, function(x) sd(x, na.rm=T) / mean(x, na.rm=T) * 100))
  

#hist.data.frame(replicates_cv[ , c(89, 178, 1022, 765, 453, 88)], nclass = 5)
```
