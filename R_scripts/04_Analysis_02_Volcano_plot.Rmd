---
title: "Make Volcano plot"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
fig_width: 15
fig_height: 17
---

### Admin

```{r, warning=F, results=F}
library(tidyverse)
library(readxl)
library(ggrepel)
library(tibble)
```

## Preparing the df

### 0. Load dataframes

Use the one with means of replicate values, no batch1, no ICI

```{r}

load("C:/Users/1aria/Desktop/rep/Data/Output_data/wide_matrix_t_means.Rda")
Metatable_means <- read_excel("C:/Users/1aria/Desktop/rep/Data/Metadata/Metatable_means.xlsx", sheet = "w nur")

# remove batch 1
wide_matrix_t_means_no_batch1 <- wide_matrix_t_means %>% select(-contains(c('NR_13', 'NR_14', 'NR_15', 'NR_16', 'NR_17', 'NR_18')))
```

### 0. Define diff_expression function

```{r}
# Provide: 
# dataset: numerical only df with genes on rows and samples as col
# colnames_conditionA/B: list containing names of all cols of interest (eg NR vs R)

diff_exp = function(dataset, colnames_conditionA, colnames_conditionB) {
  results = apply(dataset, 1, function(x) t.test(x[colnames_conditionA], x[colnames_conditionB]))
  
  colindex_conditionA <-which(colnames(dataset) %in% colnames_conditionA)
  colindex_conditionB  <-which(colnames(dataset) %in% colnames_conditionB)
  
  
  p.val = list()
  for(i in names(results)) {p.val[[i]] = results[[i]]$p.value}
  p_value = as.vector(unlist(p.val))
  
  log2_fc = rowMeans(dataset[colindex_conditionA])-rowMeans(dataset[colindex_conditionB])
  
  t_test_result = as.data.frame(cbind(names(results), log2_fc, p_value))
  colnames(t_test_result) = c("Protein", "log2_fc", "p_value")
  
  t_test_result$adj_p_value = p.adjust(t_test_result$p_value, method="fdr")
  
  # t_test_result$Gene_Name = data$X[match(res$Protein, data$geneid)]
  
  t_test_result
}
```

# N vr NR

### 0. Diff expression of R vs NR

```{r}
# Define conditions -->  colnames of R vs NR
NR_colnames <- Metatable_means %>% filter(Sample_status == 'NR') %>% select(Sample_name) %>% as.list() %>% unlist()
R_colnames <- Metatable_means %>% filter(Sample_status == 'R') %>% select(Sample_name) %>% as.list() %>% unlist()

# Run function
NR_vs_R_results = as.data.frame(diff_exp(wide_matrix_t_means_no_batch1, colnames_conditionA =NR_colnames, colnames_conditionB =R_colnames ))

save(NR_vs_R_results, file = file.path('C:','Users', '1aria', 'Desktop', 'rep', 'Data', 'Output_data', 'For_Volcano','NR_vs_R_results.Rda'))

```

### NB: you might already have it! START HERE if so

```{r}
load("C:/Users/1aria/Desktop/rep/Data/Output_data/For_Volcano/NR_vs_R_results.Rda")
```

### 1. Subset df to find significant matches

```{r}
# Which proteins are diff expressed? (adj p below 0.05?)
significant_NR_vs_R = NR_vs_R_results %>% na.omit()  %>%  filter(adj_p_value<0.05)  # 18 proteins are signid different expressed


# expand results so that easier to make volcano plot - add cols with additionak info
NR_vs_R_results_expanded <- NR_vs_R_results   %>% 
  na.omit() %>%
  mutate_at(c('log2_fc', 'p_value', 'adj_p_value'), as.numeric) %>%
  mutate(diff_expressed = "NO") %>%
  mutate(diff_expressed = if_else(condition = (log2_fc > 0.3 & adj_p_value < 0.05) , true = "UP", false = diff_expressed )) %>%
  mutate(diff_expressed = if_else(condition = (log2_fc < -0.3 & adj_p_value < 0.05) , true = "DOWN", false = diff_expressed ))   %>%
  mutate(label = NA ) %>%
  mutate(label = if_else(condition = (diff_expressed != "NO"), true = Protein, false = label))

save(NR_vs_R_results_expanded, file = 'NR_vs_R_results_expanded .Rda')
```

### 2. Plot the expanded df

```{r}
volc1 <- ggplot(data=NR_vs_R_results_expanded, aes(x=log2_fc, y=-log10(adj_p_value))) + 
  geom_point(size = 2, aes(colour=diff_expressed)) +
  theme_bw() + 
  geom_vline(xintercept=c(-0.3, 0.3), col="grey60") +
  geom_hline(yintercept=-log10(0.05), col="grey60") +
  geom_vline(xintercept=c(0, 0), col="grey60",lty = 2 ) +
  scale_color_manual(values=c("royalblue4", "black", "coral3"), labels = c("Down-regulated", "Non significant", "Up-regulated")) +
  geom_text_repel(aes(label = label, color = diff_expressed), max.overlaps = Inf) +
  scale_x_continuous(breaks = c(-1.5, -1, -0.5, -0.3, 0, 0.3, 0.5, 1, 1.5), limits = c(-1.2, 1.2))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = 'bottom',
        plot.title = element_text(size = 15, face = 'bold')) +
  labs(title= 'Volcano plot - Non responders vs responders', color = "Differentially expressed", x = 'log2(fold change)', y= '- log10(p-value)')

volc1

ggsave(path = "C:/Users/1aria/Desktop/rep/Output/Plots", filename = "Volcano_NR_vs_R.png",volc1,height=15,width=17,units="cm",dpi=200)
```

# SCR vs
